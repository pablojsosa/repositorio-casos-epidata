<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Repositorio de Casos de Éxito - Epidata</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>Repositorio de Casos de Éxito</h1>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="Buscar por nombre, partner, área o sector..." />
      
      <select id="partnerFilter">
        <option value="">Todos los Partners</option>
      </select>
      
      <select id="areaFilter">
        <option value="">Todas las Áreas</option>
      </select>
      
      <select id="sectorFilter">
        <option value="">Todos los Sectores</option>
      </select>

      <div class="view-toggle">
        <button id="gridViewBtn">Cuadrícula</button>
        <button id="listViewBtn">Lista</button>
      </div>
    </div>

    <div id="casosContainer" class="grid-view"></div>
  </div>

  <script>
    let casos = [];
    let currentView = "grid";

    fetch("casos.json")
      .then((response) => response.json())
      .then((data) => {
        casos = data;
        populateFilters();
        renderCasos();
      });

    const searchInput = document.getElementById("searchInput");
    const partnerFilter = document.getElementById("partnerFilter");
    const areaFilter = document.getElementById("areaFilter");
    const sectorFilter = document.getElementById("sectorFilter");
    const casosContainer = document.getElementById("casosContainer");

    const gridViewBtn = document.getElementById("gridViewBtn");
    const listViewBtn = document.getElementById("listViewBtn");

    gridViewBtn.onclick = () => {
      currentView = "grid";
      casosContainer.className = "grid-view";
      renderCasos();
    };

    listViewBtn.onclick = () => {
      currentView = "list";
      casosContainer.className = "list-view";
      renderCasos();
    };

    [searchInput, partnerFilter, areaFilter, sectorFilter].forEach((element) => {
      element.addEventListener("input", renderCasos);
    });

    function populateFilters() {
      const partners = [...new Set(casos.map(c => c.partner))];
      const areas = [...new Set(casos.map(c => c.area))];
      const sectores = [...new Set(casos.map(c => c.sector))];

      partners.forEach(p => {
        partnerFilter.innerHTML += `<option value="${p}">${p}</option>`;
      });

      areas.forEach(a => {
        areaFilter.innerHTML += `<option value="${a}">${a}</option>`;
      });

      sectores.forEach(s => {
        sectorFilter.innerHTML += `<option value="${s}">${s}</option>`;
      });
    }

    function highlightMatch(text, term) {
      if (!term) return text;
      const regex = new RegExp(`(${term})`, "gi");
      return text.replace(regex, '<mark>$1</mark>');
    }

    function renderCasos() {
      const searchTerm = searchInput.value.trim().toLowerCase();
      const partnerValue = partnerFilter.value;
      const areaValue = areaFilter.value;
      const sectorValue = sectorFilter.value;

      const filtered = casos.filter(caso => {
        const matchesSearch =
          caso.nombre.toLowerCase().includes(searchTerm) ||
          caso.partner.toLowerCase().includes(searchTerm) ||
          caso.area.toLowerCase().includes(searchTerm) ||
          caso.sector.toLowerCase().includes(searchTerm);

        const matchesPartner = !partnerValue || caso.partner === partnerValue;
        const matchesArea = !areaValue || caso.area === areaValue;
        const matchesSector = !sectorValue || caso.sector === sectorValue;

        return matchesSearch && matchesPartner && matchesArea && matchesSector;
      });

      casosContainer.innerHTML = "";

      if (filtered.length === 0) {
        casosContainer.innerHTML = "<p>No se encontraron casos.</p>";
        return;
      }

      filtered.forEach(caso => {
        const card = document.createElement("div");
        card.className = "caso-card";

        const title = highlightMatch(caso.nombre, searchTerm);
        const partner = highlightMatch(caso.partner, searchTerm);
        const area = highlightMatch(caso.area, searchTerm);
        const sector = highlightMatch(caso.sector, searchTerm);

        if (currentView === "grid") {
          card.innerHTML = `
            <img src="${caso.thumbnail}" alt="Thumbnail" />
            <h3>${title}</h3>
            <p><strong>Partner:</strong> ${partner}</p>
            <p><strong>Área:</strong> ${area}</p>
            <p><strong>Sector:</strong> ${sector}</p>
            <a href="${caso.link}" target="_blank">Ver presentación</a>
          `;
        } else {
          card.innerHTML = `
            <h3>${title}</h3>
            <p><strong>Partner:</strong> ${partner} | <strong>Área:</strong> ${area} | <strong>Sector:</strong> ${sector}</p>
            <a href="${caso.link}" target="_blank">Ver presentación</a>
          `;
        }

        casosContainer.appendChild(card);
      });
    }
  </script>
</body>
</html>
